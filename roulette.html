<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Velvet Vault â€” Roulette</title>

<!-- âœ… Auth + Wallet -->
<script type="module" src="js/firebase-init.js"></script>
<script type="module" src="js/guard.js"></script>
<script type="module" src="js/wallet.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#050408;
    --text:#f1ecff;
    --muted: rgba(241,236,255,0.70);
    --line: rgba(255,255,255,0.12);
    --red:#ff233d;
    --green:#00ff9a;
    --felt:#0b2a1b;
    --panel: rgba(0,0,0,0.34);
    --shadow: rgba(0,0,0,0.70);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
    background: var(--bg);
    overflow-x:hidden;
  }

  header{
    position:sticky; top:0; z-index:30;
    backdrop-filter: blur(12px);
    background: linear-gradient(180deg, rgba(8,6,12,0.88), rgba(8,6,12,0.56));
    border-bottom: 1px solid var(--line);
  }
  .topbar{
    max-width:1200px;
    margin:0 auto;
    padding:16px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brand{display:flex; gap:12px; align-items:center; min-width:0}
  .sigil{
    width:42px; height:42px; border-radius: 16px;
    border:1px solid rgba(255,255,255,0.16);
    background:
      radial-gradient(circle at 30% 30%, rgba(0,255,154,0.35), transparent 55%),
      radial-gradient(circle at 70% 70%, rgba(255,35,61,0.35), transparent 55%),
      linear-gradient(135deg, rgba(255,35,61,0.18), rgba(0,255,154,0.16));
    box-shadow: 0 16px 40px rgba(0,0,0,0.55);
    position:relative; overflow:hidden;
    flex:0 0 auto;
  }
  .sigil::after{
    content:"";
    position:absolute; inset:-35%;
    background: conic-gradient(from 180deg, transparent, rgba(255,35,61,0.25), transparent, rgba(0,255,154,0.25), transparent);
    animation: spin 10s linear infinite;
    opacity:.85;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .brand h1{
    margin:0;
    font-family:Cinzel,serif;
    font-size:16px;
    letter-spacing:.14em;
    text-transform:uppercase;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .brand small{
    display:block;
    margin-top:2px;
    color:var(--muted);
    font-size:12px;
    letter-spacing:.06em;
  }
  .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
  .chipBtn, .chipLink{
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.05);
    color: rgba(241,236,255,0.92);
    padding:10px 12px;
    border-radius:999px;
    font-weight:800;
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    transition: transform .18s ease, border-color .18s ease, background .18s ease;
    user-select:none;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .chipBtn:hover, .chipLink:hover{transform:translateY(-1px)}
  .chipBtn.red:hover{border-color: rgba(255,35,61,.35); background: rgba(255,35,61,.08)}
  .chipBtn.green:hover, .chipLink.green:hover{border-color: rgba(0,255,154,.35); background: rgba(0,255,154,.08)}

  main{max-width:1200px;margin:0 auto;padding:18px 18px 90px}

  .stage{
    position:relative;
    border-radius:22px;
    border:1px solid var(--line);
    overflow:hidden;
    box-shadow: 0 30px 90px var(--shadow);
    background:
      radial-gradient(1200px 700px at 50% 22%, rgba(0,255,154,0.10), transparent 60%),
      radial-gradient(1200px 700px at 50% 28%, rgba(255,35,61,0.10), transparent 62%),
      radial-gradient(900px 520px at 50% 45%, rgba(0,0,0,0.14), rgba(0,0,0,0.86)),
      linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.78));
  }
  .stage::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(900px 520px at 50% 18%, rgba(0,255,154,0.06), transparent 60%),
      radial-gradient(900px 520px at 50% 30%, rgba(255,35,61,0.07), transparent 63%),
      linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.0));
    pointer-events:none;
  }
  .stage > *{position:relative; z-index:2}

  .hudRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(10px);
  }
  .pill{
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.22);
    padding:10px 12px;
    border-radius:999px;
    font-size:12px;
    color: rgba(241,236,255,0.92);
    white-space:nowrap;
  }
  .pill b{color: var(--green)}
  .pill .r{color: var(--red)}

  .grid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:16px;
    padding:16px;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns: 1fr; }
  }

  /* ===== Wheel ===== */
  .wheelPanel{
    border-radius: 18px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.30);
    backdrop-filter: blur(10px);
    padding:14px;
    box-shadow: 0 18px 50px rgba(0,0,0,0.45);
    position:relative;
    overflow:hidden;
  }
  .wheelWrap{
    display:grid;
    place-items:center;
    width:100%;
    aspect-ratio: 1 / 1;
    max-width: 390px;
    margin: 0 auto;
    position:relative;
  }
  .wheelImage{
    position:absolute;
    inset:0;
    border-radius:50%;
    background:
      radial-gradient(circle at 40% 35%, rgba(255,255,255,0.10), transparent 45%),
      radial-gradient(circle at 50% 60%, rgba(0,0,0,0.75), rgba(0,0,0,0.92)),
      url("images/roulette-wheel.png") center/cover no-repeat;
    border:1px solid rgba(255,255,255,0.10);
    box-shadow:
      0 0 22px rgba(0,255,154,.18),
      0 0 26px rgba(255,35,61,.18),
      0 30px 80px rgba(0,0,0,.65);
  }
  .wheelRing{
    position:absolute;
    inset: 12%;
    border-radius:50%;
    border:1px solid rgba(255,255,255,0.14);
    background:
      conic-gradient(
        #1b1b24 0 10deg, #c8132a 10deg 20deg,
        #1b1b24 20deg 30deg, #c8132a 30deg 40deg,
        #1b1b24 40deg 50deg, #c8132a 50deg 60deg,
        #1b1b24 60deg 70deg, #0a6d4b 70deg 78deg,
        #1b1b24 78deg 88deg, #c8132a 88deg 98deg,
        #1b1b24 98deg 108deg, #c8132a 108deg 118deg,
        #1b1b24 118deg 128deg, #c8132a 128deg 138deg,
        #1b1b24 138deg 148deg, #c8132a 148deg 158deg,
        #1b1b24 158deg 168deg, #c8132a 168deg 178deg,
        #1b1b24 178deg 188deg, #c8132a 188deg 198deg,
        #1b1b24 198deg 208deg, #c8132a 208deg 218deg,
        #1b1b24 218deg 228deg, #c8132a 228deg 238deg,
        #1b1b24 238deg 248deg, #c8132a 248deg 258deg,
        #1b1b24 258deg 268deg, #c8132a 268deg 278deg,
        #1b1b24 278deg 288deg, #c8132a 288deg 298deg,
        #1b1b24 298deg 308deg, #c8132a 308deg 318deg,
        #1b1b24 318deg 328deg, #c8132a 328deg 338deg,
        #1b1b24 338deg 348deg, #c8132a 348deg 360deg
      );
    box-shadow: inset 0 0 30px rgba(0,0,0,0.65);
    transform: rotate(var(--wheelRot, 0deg));
    transition: transform var(--wheelDur, 4600ms) cubic-bezier(.12,.92,.12,1);
  }
  .wheelHub{
    position:absolute;
    width: 34%;
    height: 34%;
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), rgba(0,0,0,0.78));
    border:1px solid rgba(255,255,255,0.10);
    box-shadow: 0 12px 40px rgba(0,0,0,.55);
  }
  .ball{
    position:absolute;
    width: 12px;
    height: 12px;
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(255,255,255,0.25));
    box-shadow: 0 0 10px rgba(255,255,255,0.25), 0 0 18px rgba(0,255,154,0.10);
    transform: translate(-50%, -50%);
    left: 50%;
    top: 50%;
  }
  .ballOrbit{
    --r: 44%;
    --a: 0deg;
    transform:
      translate(-50%, -50%)
      rotate(var(--a))
      translateX(var(--r))
      rotate(calc(-1 * var(--a)));
    transition:
      transform var(--ballDur, 4600ms) cubic-bezier(.10,.90,.15,1);
  }
  .wheelControls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top: 12px;
  }
  .btn{
    border-radius:14px;
    padding:12px 14px;
    border:1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.28);
    color: var(--text);
    font-weight:900;
    letter-spacing:0.10em;
    text-transform:uppercase;
    cursor:pointer;
    transition: transform .18s ease, border-color .18s ease, background .18s ease;
    user-select:none;
    min-width: 160px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }
  .btn.green:hover{ border-color: rgba(0,255,154,0.35); background: rgba(0,255,154,0.08); }
  .btn.red:hover{ border-color: rgba(255,35,61,0.35); background: rgba(255,35,61,0.08); }

  .log{
    margin-top: 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.22);
    padding: 12px 12px;
    color: rgba(241,236,255,0.90);
    font-size: 13px;
    line-height: 1.35;
    min-height: 44px;
  }
  .log b{ color: var(--green); }

  /* ===== Board ===== */
  .boardPanel{
    border-radius: 18px;
    border:1px solid rgba(255,255,255,0.12);
    background:
      radial-gradient(900px 520px at 50% 30%, rgba(0,0,0,0.18), rgba(0,0,0,0.70)),
      url("images/roulette-board.jpg") center/cover no-repeat,
      linear-gradient(180deg, rgba(11,42,27,0.95), rgba(7,20,13,0.98));
    padding:14px;
    box-shadow: 0 18px 50px rgba(0,0,0,0.45);
    position:relative;
  }

  /* Grid with spacer rows/cols so we can place split/corner spots */
  .layout{
    display:grid;
    grid-template-columns: 70px 1fr 12px 1fr 12px 1fr;
    grid-auto-rows: 46px;
    gap:6px;
    align-items:stretch;
  }
  .rowGap{
    grid-column: 1 / -1;
    height: 10px;
    margin: -2px 0;
  }

  .cell{
    position:relative;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.18);
    display:grid;
    place-items:center;
    padding:10px 6px;
    font-weight:900;
    letter-spacing:.06em;
    user-select:none;
    cursor:pointer;
    min-height: 44px;
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .cell:hover{
    transform: translateY(-1px);
    border-color: rgba(0,255,154,0.22);
    box-shadow: 0 0 18px rgba(0,255,154,0.10), 0 0 18px rgba(255,35,61,0.08);
  }
  .nRed{ background: rgba(255,35,61,0.16); }
  .nBlack{ background: rgba(20,20,26,0.30); }
  .nGreen{ background: rgba(0,255,154,0.12); }

  .label{
    cursor:default;
    opacity:.9;
    background: rgba(0,0,0,0.26);
    font-weight:800;
  }

  /* bet spots for split/corner */
  .spot{
    position:relative;
    border-radius: 10px;
    border: 1px dashed rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.04);
    display:grid;
    place-items:center;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    min-height: 44px;
  }
  .spot:hover{
    transform: translateY(-1px);
    border-color: rgba(0,255,154,0.26);
    background: rgba(0,255,154,0.05);
  }
  .spot small{
    font-size:10px;
    letter-spacing:.12em;
    text-transform:uppercase;
    opacity:.85;
  }

  .chipStack{
    position:absolute;
    right:6px;
    bottom:6px;
    display:flex;
    flex-direction:column-reverse;
    gap:3px;
    pointer-events:none;
    align-items:flex-end;
  }
  .chip{
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.22);
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), rgba(255,35,61,0.95));
    box-shadow: 0 0 16px rgba(255,35,61,0.14);
  }
  .chip.g{
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), rgba(0,255,154,0.92));
    box-shadow: 0 0 16px rgba(0,255,154,0.12);
  }

  .outside{
    margin-top: 12px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .outside2{
    margin-top: 10px;
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:10px;
  }

  .boardFooter{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    margin-top: 12px;
  }
  .betBox{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.20);
    padding: 10px 12px;
    border-radius: 14px;
  }
  .betBox label{
    font-size:12px;
    letter-spacing:0.10em;
    text-transform:uppercase;
    color: rgba(241,236,255,0.86);
    font-weight:900;
  }
  .betBox input[type="range"]{ width: 180px; }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="sigil" aria-hidden="true"></div>
      <div>
        <h1>Velvet Vault</h1>
        <small>Roulette â€¢ Split / Street / Corner â€¢ Neon Vegas</small>
      </div>
    </div>
    <div class="actions">
      <a class="chipLink green" href="members.html">Lobby</a>
      <a class="chipLink" href="ledger.html">Ledger</a>
      <button class="chipBtn red" id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<main>
  <section class="stage" aria-label="Roulette">
    <div class="hudRow">
      <div class="pill">Wallet: <b id="walletBal">â€”</b></div>
      <div class="pill">Chip: <b id="chipVal">100</b></div>
      <div class="pill">Total Bet: <b id="totalBet">0</b></div>
      <div class="pill">Last: <b id="lastResult">â€”</b></div>
      <div class="pill">Status: <b id="status">READY</b></div>
    </div>

    <div class="grid">
      <!-- WHEEL -->
      <div class="wheelPanel">
        <div class="wheelWrap">
          <div class="wheelImage" aria-hidden="true"></div>
          <div class="wheelRing" id="wheelRing" aria-hidden="true"></div>
          <div class="wheelHub" aria-hidden="true"></div>
          <div class="ball ballOrbit" id="ball"></div>
        </div>

        <div class="wheelControls">
          <button class="btn green" id="spinBtn">Spin</button>
          <button class="btn" id="clearBtn">Clear Bets</button>
        </div>

        <div class="log" id="log">Click numbers, split lines, corners, or street labels to place chips.</div>
      </div>

      <!-- BOARD -->
      <div class="boardPanel">
        <div class="layout" id="layout"></div>

        <div class="outside" id="dozens"></div>
        <div class="outside2" id="evens"></div>

        <div class="boardFooter">
          <div class="betBox">
            <label>Chip Amount</label>
            <input id="chipSlider" type="range" min="10" max="1000" step="10" value="100">
            <div class="pill">Amt: <b id="chipAmt">100</b></div>
          </div>
          <div class="pill">Payouts: Straight <b>35:1</b> â€¢ Split <b>17:1</b> â€¢ Street <b>11:1</b> â€¢ Corner <b>8:1</b></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* =========================
   ðŸ”Š SOUND (WebAudio tiny)
   ========================= */
let AC=null;
function audioOn(){ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); if(AC.state==="suspended") AC.resume(); }
function beep(freq=440, ms=60, type="sine", gain=0.05){
  if(!AC) return;
  const o=AC.createOscillator(), g=AC.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=gain;
  o.connect(g); g.connect(AC.destination);
  o.start(); setTimeout(()=>o.stop(), ms);
}
function chime(){ beep(660,70,"sine",0.05); setTimeout(()=>beep(880,90,"sine",0.05),80); }
function thud(){ beep(140,90,"triangle",0.06); }
function tick(){ beep(520,30,"square",0.02); }

/* =========================
   ðŸ’³ WALLET UI
   ========================= */
const walletBalEl = document.getElementById("walletBal");
function renderWallet(){
  if(!window.VaultEngine?.user) return;
  walletBalEl.textContent = window.VaultEngine.formatGold(window.VaultEngine.getBalance());
}
const wWait = setInterval(() => {
  if(window.VaultEngine){
    clearInterval(wWait);
    window.VaultEngine.subscribe(renderWallet);
    renderWallet();
  }
}, 100);

const logEl = document.getElementById("log");
function requireWallet(){
  if(!window.VaultEngine?.user){
    logEl.textContent = "Connecting to the vaultâ€¦";
    return false;
  }
  return true;
}
function debit(amount, note){
  if(!requireWallet()) return false;
  const ok = window.VaultEngine.debit(amount, note);
  if(!ok){
    const bal = window.VaultEngine.getBalance?.() ?? 0;
    logEl.innerHTML = `Insufficient funds. Wallet: <b>${window.VaultEngine.formatGold(bal)}</b>`;
    thud();
    return false;
  }
  return true;
}
function credit(amount, note){
  if(!window.VaultEngine?.user) return;
  window.VaultEngine.credit(amount, note);
}

/* =========================
   ðŸŽ¯ Wheel order + colors
   ========================= */
const WHEEL_ORDER = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const RED_SET = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
function colorOf(n){
  if(n===0) return "green";
  return RED_SET.has(n) ? "red" : "black";
}

/* =========================
   ðŸ§¾ Bets + payouts
   ========================= */
const PAYOUTS = {
  straight: 35,
  split: 17,
  street: 11,
  corner: 8,
  dozen: 2,
  even: 1
};

const BETS = new Map(); // key -> {type, nums:Set<number>, amount}
function key(type, id){ return type + ":" + id; }

function totalBet(){
  let t=0;
  for(const b of BETS.values()) t += b.amount;
  return t;
}

function addChipVisual(stack){
  const c = document.createElement("div");
  c.className = "chip " + (Math.random()>0.5 ? "g" : "");
  stack.appendChild(c);
  while(stack.children.length > 10) stack.removeChild(stack.firstChild);
}

/* =========================
   ðŸ§± UI build: numbers + split + corner + street
   ========================= */
const layoutEl = document.getElementById("layout");
const dozensEl = document.getElementById("dozens");
const evensEl = document.getElementById("evens");

const totalBetEl = document.getElementById("totalBet");
const chipValEl = document.getElementById("chipVal");
const chipAmtEl = document.getElementById("chipAmt");
const lastResultEl = document.getElementById("lastResult");
const statusEl = document.getElementById("status");

const chipSlider = document.getElementById("chipSlider");
let chipValue = Number(chipSlider.value||100);
chipSlider.addEventListener("input", ()=>{
  chipValue = Number(chipSlider.value||100);
  chipValEl.textContent = chipValue;
  chipAmtEl.textContent = chipValue;
});

function placeBet(type, id, nums, stack){
  const k = key(type, id);
  const existing = BETS.get(k);
  if(existing) existing.amount += chipValue;
  else BETS.set(k, { type, nums: new Set(nums), amount: chipValue });
  addChipVisual(stack);
  totalBetEl.textContent = totalBet();
}

function mkStack(){
  const s = document.createElement("div");
  s.className = "chipStack";
  return s;
}

function mkNumberCell(n){
  const d = document.createElement("div");
  const c = colorOf(n);
  d.className = "cell " + (c==="red" ? "nRed" : c==="black" ? "nBlack" : "nGreen");
  d.textContent = String(n);
  const stack = mkStack();
  d.appendChild(stack);
  d.addEventListener("click", ()=>{
    audioOn(); tick();
    placeBet("straight", String(n), [n], stack);
  });
  return d;
}

function mkStreetCell(start){
  const d = document.createElement("div");
  d.className = "cell label";
  d.textContent = "ST";
  const stack = mkStack();
  d.appendChild(stack);
  d.title = `Street ${start}-${start+2}`;
  d.addEventListener("click", ()=>{
    audioOn(); tick();
    placeBet("street", String(start), [start,start+1,start+2], stack);
  });
  return d;
}

function mkSpot(type, id, nums, label){
  const d = document.createElement("div");
  d.className = "spot";
  d.innerHTML = `<small>${label||type}</small>`;
  const stack = mkStack();
  d.appendChild(stack);
  d.addEventListener("click", ()=>{
    audioOn(); tick();
    placeBet(type, id, nums, stack);
  });
  return d;
}

function buildLayout(){
  layoutEl.innerHTML = "";

  // Build rows top-to-bottom: 12 streets: (1-3) ... (34-36)
  // Our visual layout goes from 1-3 at top (classic).
  const rows = [];
  for(let r=0;r<12;r++){
    const start = 1 + r*3;
    rows.push([start, start+1, start+2]);
  }

  // For each row: street cell + n1 + vsplit + n2 + vsplit + n3
  rows.forEach((nums, rIdx)=>{
    // street bet
    layoutEl.appendChild(mkStreetCell(nums[0]));

    // number 1
    layoutEl.appendChild(mkNumberCell(nums[0]));

    // split between n1-n2 (horizontal split)
    layoutEl.appendChild(mkSpot("split", `${nums[0]}-${nums[1]}`, [nums[0],nums[1]], "SPLIT"));

    // number 2
    layoutEl.appendChild(mkNumberCell(nums[1]));

    // split between n2-n3
    layoutEl.appendChild(mkSpot("split", `${nums[1]}-${nums[2]}`, [nums[1],nums[2]], "SPLIT"));

    // number 3
    layoutEl.appendChild(mkNumberCell(nums[2]));

    // Between rows: vertical splits + corners (except after last row)
    if(rIdx < rows.length-1){
      const below = rows[rIdx+1]; // [n+3, n+4, n+5]

      // Add a thin gap row (visual spacer)
      const gap = document.createElement("div");
      gap.className = "rowGap";
      layoutEl.appendChild(gap);

      // Now an overlay row of clickable spots for vertical/corner
      // street column placeholder
      layoutEl.appendChild(Object.assign(document.createElement("div"), {className:"cell label", textContent:""}));

      // vertical split n1 with below n1 (+3)
      layoutEl.appendChild(mkSpot("split", `${nums[0]}-${below[0]}`, [nums[0],below[0]], "V"));

      // corner (n1,n2,below1,below2)
      layoutEl.appendChild(mkSpot("corner", `${nums[0]}-${nums[1]}-${below[0]}-${below[1]}`, [nums[0],nums[1],below[0],below[1]], "C"));

      // vertical split n2 with below n2 (+3)
      layoutEl.appendChild(mkSpot("split", `${nums[1]}-${below[1]}`, [nums[1],below[1]], "V"));

      // corner (n2,n3,below2,below3)
      layoutEl.appendChild(mkSpot("corner", `${nums[1]}-${nums[2]}-${below[1]}-${below[2]}`, [nums[1],nums[2],below[1],below[2]], "C"));

      // vertical split n3 with below n3 (+3)
      layoutEl.appendChild(mkSpot("split", `${nums[2]}-${below[2]}`, [nums[2],below[2]], "V"));
    }
  });

  // Dozens
  dozensEl.innerHTML = "";
  const d1 = mkSpot("dozen","1",[...Array(12)].map((_,i)=>i+1),"1st 12");
  const d2 = mkSpot("dozen","2",[...Array(12)].map((_,i)=>i+13),"2nd 12");
  const d3 = mkSpot("dozen","3",[...Array(12)].map((_,i)=>i+25),"3rd 12");
  d1.classList.add("cell"); d2.classList.add("cell"); d3.classList.add("cell");
  dozensEl.appendChild(d1); dozensEl.appendChild(d2); dozensEl.appendChild(d3);

  // Even money
  evensEl.innerHTML = "";
  const low = mkSpot("even","low",[...Array(18)].map((_,i)=>i+1),"1â€“18");
  const even = mkSpot("even","even",[...Array(18)].map((_,i)=>2*(i+1)).filter(n=>n<=36),"EVEN");
  const red = mkSpot("even","red",[...RED_SET],"RED");
  const black = mkSpot("even","black",[...Array(36)].map((_,i)=>i+1).filter(n=>!RED_SET.has(n)),"BLACK");
  const odd = mkSpot("even","odd",[...Array(18)].map((_,i)=>2*i+1),"ODD");
  const high = mkSpot("even","high",[...Array(18)].map((_,i)=>i+19),"19â€“36");
  [low,even,red,black,odd,high].forEach(x=>{ x.classList.add("cell"); evensEl.appendChild(x); });

  totalBetEl.textContent = "0";
}
buildLayout();

function clearBets(){
  BETS.clear();
  document.querySelectorAll(".chipStack").forEach(s=>s.innerHTML="");
  totalBetEl.textContent = "0";
  logEl.textContent = "Bets cleared.";
}

/* =========================
   ðŸŽ¡ Spin + ball landing
   ========================= */
const wheelRing = document.getElementById("wheelRing");
const ball = document.getElementById("ball");
const spinBtn = document.getElementById("spinBtn");
const clearBtn = document.getElementById("clearBtn");

let spinning = false;

function pocketAngleForNumber(n){
  const idx = WHEEL_ORDER.indexOf(n);
  const pocketSize = 360 / WHEEL_ORDER.length;
  return (idx * pocketSize);
}
function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function resolvePayout(win){
  let payout = 0;
  for(const b of BETS.values()){
    if(b.nums.has(win)){
      const mult = PAYOUTS[b.type] ?? 0;
      payout += b.amount * (mult + 1);
    }
  }
  return payout;
}

async function spin(){
  audioOn();
  if(spinning) return;

  const wager = totalBet();
  if(wager <= 0){
    logEl.textContent = "Place a bet first.";
    thud();
    return;
  }
  if(!debit(wager, "roulette-spin")) return;

  spinning = true;
  spinBtn.disabled = true;
  clearBtn.disabled = true;
  statusEl.textContent = "SPINNING";

  const win = WHEEL_ORDER[randInt(0, WHEEL_ORDER.length-1)];
  const winAngle = pocketAngleForNumber(win);

  const dur = randInt(4400, 5900);
  wheelRing.style.setProperty("--wheelDur", dur + "ms");
  ball.style.setProperty("--ballDur", dur + "ms");

  const extraTurns = randInt(9, 14) * 360;
  const finalWheel = extraTurns + (360 - winAngle) + randInt(-4,4);

  const ballTurns = randInt(11, 17) * 360;
  const finalBall = ballTurns + winAngle + randInt(-6,6);

  wheelRing.style.setProperty("--wheelRot", finalWheel + "deg");
  ball.style.setProperty("--a", finalBall + "deg");

  // â€œbounce / dropâ€ radius
  ball.style.setProperty("--r", "48%");
  tick();
  setTimeout(()=>{ ball.style.setProperty("--r","46%"); tick(); }, Math.floor(dur*0.25));
  setTimeout(()=>{ ball.style.setProperty("--r","44%"); tick(); }, Math.floor(dur*0.50));
  setTimeout(()=>{ ball.style.setProperty("--r","42%"); tick(); }, Math.floor(dur*0.70));
  setTimeout(()=>{ ball.style.setProperty("--r","40%"); tick(); }, Math.floor(dur*0.86));
  setTimeout(()=>{ ball.style.setProperty("--r","38%"); }, Math.floor(dur*0.95));

  logEl.innerHTML = `Spinningâ€¦ <b>No more bets</b>.`;
  await sleep(dur + 100);

  lastResultEl.innerHTML = `${win} <span class="${colorOf(win)==="red"?"r":""}">${colorOf(win).toUpperCase()}</span>`;

  const payout = resolvePayout(win);
  if(payout > 0){
    credit(payout, "roulette-payout");
    chime();
    logEl.innerHTML = `Result: <b>${win}</b>. You win <b>${payout}</b> GOLD.`;
  }else{
    thud();
    logEl.innerHTML = `Result: <b>${win}</b>. Dealer takes it.`;
  }

  renderWallet();
  clearBets();

  statusEl.textContent = "READY";
  spinning = false;
  spinBtn.disabled = false;
  clearBtn.disabled = false;
}

spinBtn.addEventListener("click", spin);
clearBtn.addEventListener("click", clearBets);
</script>

</body>
</html>
